FROM php:7.4-cli

# Install required system dependencies
RUN apt-get clean && apt-get update -y && apt-get install -y --no-install-recommends \
    libonig-dev \
    libxml2-dev \
    libssl-dev \
    libjpeg-dev \
    libpng-dev \
    libfreetype6-dev \
    libzip-dev \
    libexif-dev \
    libmemcached-dev \
    zlib1g-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Configure and install GD extension with JPEG support
RUN docker-php-ext-configure gd --with-jpeg --with-freetype \
    && docker-php-ext-install gd

# Install PHP extensions
RUN docker-php-ext-install \
    bcmath \
    ctype \
    fileinfo \
    pdo_mysql \
    xml \
    exif \
    zip \
    pcntl

WORKDIR /var/www/transport_management_system

# Copy application code
COPY . /var/www/transport_management_system
COPY .env.example /var/www/transport_management_system/.env

# Permissions and setup
RUN chmod -R 777 /var/www/transport_management_system/storage
RUN umask 022

# Install Composer
RUN php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
RUN php composer-setup.php --install-dir=/usr/local/bin --filename=composer

ENV COMPOSER_ALLOW_SUPERUSER=1
RUN composer install --no-interaction --optimize-autoloader

# Set recommended PHP configurations
RUN { \
    echo 'date.timezone = "Asia/Dhaka"'; \
    echo 'memory_limit = 256M'; \
    echo 'post_max_size = 128M'; \
    echo 'upload_max_filesize = 128M'; \
    echo 'pm.max_children = 100'; \
    } > /usr/local/etc/php/conf.d/recommended.ini

# Start Laravel app using artisan serve (default for dev)
CMD [ "php", "artisan", "serve", "--host=0.0.0.0", "--port=8000" ]
